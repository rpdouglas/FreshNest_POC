<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fresh Nest Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Lighter gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0; /* gray-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* gray-500 */
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Active Nav Tab */
        .nav-btn.active {
            background-color: #ecfdf5; /* green-50 */
            color: #065f46; /* green-800 */
            border-left: 4px solid #059669; /* green-600 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Spinner (Hidden by default) -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <svg class="animate-spin h-10 w-10 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Message Modal (Hidden by default) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message-text" class="text-lg font-medium text-gray-800"></p>
            <button id="modal-close-btn" class="mt-4 bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">
                OK
            </button>
        </div>
    </div>
    
    <!-- Login Screen (Visible by default) -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-6 bg-white p-8 rounded-lg shadow-lg text-center">
            <div>
                <svg class="mx-auto h-12 w-auto text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M12.75 21h-7.5a.75.75 0 0 1-.75-.75V8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21" />
                </svg>
                <h2 class="mt-4 text-3xl font-bold text-gray-900">
                    Fresh Nest Manager
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Sign in to continue
                </p>
            </div>
            
            <button id="google-login-btn" class="w-full flex justify-center items-center gap-3 bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512" fill="currentColor">
                    <path d="M488 261.8C488 403.3 381.5 512 244 512 111.8 512 0 400.2 0 261.8 0 123.3 111.8 11.8 244 11.8 300.9 11.8 349.8 31.2 388.3 66.5L336.4 118.4C316.5 99.8 285.1 81.3 244 81.3 156.4 81.3 87 150.1 87 237.4c0 87.2 69.4 156.1 157 156.1 91.8 0 138.2-62.2 142.9-92.4H244V271.3h239.3c5.1 27.2 7.7 56.4 7.7 85.5z"/>
                </svg>
                <span>Sign in with Google</span>
            </button>

            <!-- Divider -->
            <div class="my-4 flex items-center justify-center">
                <span class="border-b w-1/4"></span>
                <span class="px-2 text-xs uppercase text-gray-500">Or</span>
                <span class="border-b w-1/4"></span>
            </div>

            <!-- New SysAdmin Login Form -->
            <form id="admin-login-form" class="space-y-3">
                <div>
                    <label for="admin-pass" class="block text-sm font-medium text-gray-700 text-left">SysAdmin Login</label>
                    <input type="password" id="admin-pass" name="adminPass" placeholder="Enter password" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <button type="submit" class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transition-colors">
                    Login
                </button>
            </form>

        </div>
    </div>


    <!-- Main App Container (Hidden by default) -->
    <div id="app-container" class="hidden max-w-7xl mx-auto">

        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <svg class="h-8 w-auto text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M12.75 21h-7.5a.75.75 0 0 1-.75-.75V8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21" />
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">Fresh Nest Manager</h1>
            </div>
            <button id="logout-btn" class="text-sm font-medium text-gray-600 hover:text-emerald-700">
                Logout
            </button>
        </header>

        <!-- Main Content -->
        <div class="flex">
            <!-- Navigation Sidebar -->
            <nav class="w-64 bg-white p-4 space-y-2 h-screen-minus-header sticky top-16">
                <button id="jobs-nav-btn" class="nav-btn w-full text-left p-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-3 active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm2 2a1 1 0 011 1v1a1 1 0 11-2 0V5a1 1 0 011-1zM6 8a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Jobs
                </button>
                <button id="clients-nav-btn" class="nav-btn w-full text-left p-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0118 15v3h-2zM4 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 016 15v3H4z" />
                    </svg>
                    Clients
                </button>
                <button id="staff-nav-btn" class="nav-btn w-full text-left p-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    Staff
                </button>
                <button id="timesheets-nav-btn" class="nav-btn w-full text-left p-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-3">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                    </svg>
                    Timesheets
                </button>
            </nav>

            <!-- Main Content Area -->
            <main class="flex-1 p-6 h-screen-minus-header overflow-y-auto">

                <!-- ================== -->
                <!-- === JOBS SECTION === -->
                <!-- ================== -->
                <section id="jobs-section">
                    <!-- Add New Job Form -->
                    <div class="bg-white p-5 rounded-lg shadow-lg mb-6">
                        <h2 class="text-xl font-bold text-emerald-800 mb-4">Schedule a New Job</h2>
                        <form id="add-job-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="job-client" class="block text-sm font-medium text-gray-700">Client</label>
                                    <select id="job-client" name="jobClient" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="">Loading clients...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="job-date" class="block text-sm font-medium text-gray-700">Job Date</label>
                                    <input type="date" id="job-date" name="jobDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>
                            <div>
                                <label for="job-staff" class="block text-sm font-medium text-gray-700">Assign Staff</label>
                                <select id="job-staff" name="jobStaff" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="">Loading staff...</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">
                                Add Job
                            </button>
                        </form>
                    </div>

                    <!-- Upcoming Jobs List -->
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Upcoming Jobs</h2>
                        <div id="jobs-list" class="space-y-3">
                            <!-- Jobs will be injected here -->
                        </div>
                    </div>
                </section>

                <!-- ===================== -->
                <!-- === CLIENTS SECTION === -->
                <!-- ===================== -->
                <section id="clients-section" class="hidden">
                    <!-- Add New Client Form -->
                    <div class="bg-white p-5 rounded-lg shadow-lg mb-6">
                        <h2 class="text-xl font-bold text-emerald-800 mb-4">Add New Client</h2>
                        <form id="add-client-form" class="space-y-4">
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                                <input type="text" id="client-name" name="clientName" placeholder="e.g., John Doe or Acme Inc." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="client-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                                    <input type="tel" id="client-phone" name="clientPhone" placeholder="e.g., (555) 123-4567" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="client-type" class="block text-sm font-medium text-gray-700">Client Type</label>
                                    <select id="client-type" name="clientType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="residential">Residential</option>
                                        <option value="commercial">Commercial</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="client-address" class="block text-sm font-medium text-gray-700">Address</label>
                                <input type="text" id="client-address" name="clientAddress" placeholder="e.g., 123 Main St, Anytown, USA" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">
                                Add Client
                            </button>
                        </form>
                    </div>

                    <!-- Client List -->
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Clients</h2>
                        <div id="clients-list" class="space-y-3">
                            <!-- Clients will be injected here -->
                        </div>
                    </div>
                </section>

                <!-- =================== -->
                <!-- === STAFF SECTION === -->
                <!-- =================== -->
                <section id="staff-section" class="hidden">
                    <!-- Add New Staff Form -->
                    <div class="bg-white p-5 rounded-lg shadow-lg mb-6">
                        <h2 class="text-xl font-bold text-emerald-800 mb-4">Add New Staff Member</h2>
                        <form id="add-staff-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="staff-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="staff-name" name="staffName" placeholder="e.g., Jane Smith" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="staff-type" class="block text-sm font-medium text-gray-700">Staff Role</label>
                                    <select id="staff-type" name="staffType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="">Select Role</option>
                                        <option value="Owner">Owner</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Team Leader">Team Leader</option>
                                        <option value="Cleaner">Cleaner</option>
                                        <option value="SysAdmin">SysAdmin</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="staff-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                                    <input type="tel" id="staff-phone" name="staffPhone" placeholder="e.g., (555) 123-4567" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="staff-email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="staff-email" name="staffEmail" placeholder="e.g., jane@freshnest.com" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>
                            
                            <div>
                                <label for="staff-address" class="block text-sm font-medium text-gray-700">Address</label>
                                <input type="text" id="staff-address" name="staffAddress" placeholder="e.g., 456 Oak Ave" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="staff-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                                    <input type="date" id="staff-start-date" name="staffStartDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="staff-pay-rate" class="block text-sm font-medium text-gray-700">Pay Rate (per hour)</label>
                                    <input type="number" id="staff-pay-rate" name="staffPayRate" min="0" step="0.01" placeholder="e.g., 22.50" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">
                                Add Staff
                            </button>
                        </form>
                    </div>

                    <!-- Staff List -->
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Staff</h2>
                        <div id="staff-list" class="space-y-3">
                            <!-- Staff will be injected here -->
                        </div>
                    </div>
                </section>

                <!-- ======================== -->
                <!-- === TIMESHEETS SECTION === -->
                <!-- ======================== -->
                <section id="timesheets-section" class="hidden">
                    <!-- Log Time Form -->
                    <div class="bg-white p-5 rounded-lg shadow-lg mb-6">
                        <h2 class="text-xl font-bold text-emerald-800 mb-4">Log Staff Hours</h2>
                        <form id="add-time-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label for="time-staff" class="block text-sm font-medium text-gray-700">Staff Member</label>
                                    <select id="time-staff" name="timeStaff" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="">Loading staff...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="time-date" class="block text-sm font-medium text-gray-700">Date</label>
                                    <input type="date" id="time-date" name="timeDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="time-hours" class="block text-sm font-medium text-gray-700">Hours Worked</label>
                                    <input type="number" id="time-hours" name="timeHours" min="0" step="0.25" placeholder="e.g., 8.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">
                                Log Hours
                            </button>
                        </form>
                    </div>

                    <!-- Timesheet "Spreadsheet" -->
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Logged Timesheets</h2>
                        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                                        <th scope="col" class="relative px-6 py-3">
                                            <span class="sr-only">Delete</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="timesheets-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Timesheet entries will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            signInAnonymously // Import anonymous sign-in
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            deleteDoc, 
            onSnapshot, 
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        // This is the config you provided
        const firebaseConfig = {
            apiKey: "AIzaSyC0vpYDeCNk0wYddQadw3kkzCfiVQQv8Bk",
            authDomain: "freshnest-aa51e.firebaseapp.com",
            projectId: "freshnest-aa51e",
            storageBucket: "freshnest-aa51e.firebasestorage.app",
            messagingSenderId: "521227407391",
            appId: "1:521227407391:web:c7d1886cf87a74434e452a",
            measurementId: "G-NHB0PXTDLK"
        };
        
        // --- App ID ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Global App Variables ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Firebase listeners (to detach later)
        let unsubClients = () => {};
        let unsubStaff = () => {};
        let unsubJobs = () => {};
        let unsubTimesheets = () => {};

        // UI Element Globals
        let navButtons, sections;
        let addJobForm, addClientForm, addStaffForm, addTimeForm;
        let jobsList, clientsList, staffList, timesheetsList;
        let jobClientSelect, jobStaffSelect, timeStaffSelect;
        let loadingSpinner, messageModal;
        
        // Auth UI Elements
        let loginSection, mainAppContainer, googleLoginBtn, logoutBtn, adminLoginForm;

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore debug logging
                
                // Set up the authentication state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        console.log("User signed in with UID:", userId);
                        isAuthReady = true;
                        
                        // Detach any old listeners and attach new ones for this user
                        detachFirestoreListeners(); 
                        attachFirestoreListeners();
                        
                        showMainApp(); // Show the main app UI
                    } else {
                        // User is signed out
                        userId = null;
                        isAuthReady = false;
                        console.log("User signed out.");
                        
                        // Stop listening to data
                        detachFirestoreListeners();
                        
                        showLoginScreen(); // Show the login screen
                    }
                    hideLoading(); // Hide spinner after auth state is resolved
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showMessage("Could not initialize app. Please refresh.", "error");
            }
        }

        // --- Auth Functions ---

        async function handleGoogleLogin() {
            if (!auth) return;
            showLoading(); // Show spinner
            const provider = new GoogleAuthProvider();
            try {
                // This will trigger the onAuthStateChanged listener
                await signInWithPopup(auth, provider);
                // On success, onAuthStateChanged handles showing the app
            } catch (error) {
                console.error("Google Login Error:", error);
                showMessage("Could not login with Google, please try again", "error");
                hideLoading(); // Hide spinner on error
            }
        }

        // Updated function for SysAdmin login
        async function handleAdminLogin(e) {
            e.preventDefault();
            if (!adminLoginForm || !auth) return; // Guard clause
            
            const pass = adminLoginForm.adminPass.value;
            
            if (pass === "Nest2012") {
                // Password is correct.
                console.log("SysAdmin password correct. Attempting anonymous sign-in...");
                showLoading();
                
                try {
                    // Sign in anonymously. This WILL trigger onAuthStateChanged.
                    // The 'userId' will be the anonymous user's UID.
                    // All data will be saved under this UID, but it's a REAL auth session.
                    await signInAnonymously(auth);
                    
                    // onAuthStateChanged will handle hiding the spinner and showing the app
                    console.log("SysAdmin anonymous sign-in successful.");
                    
                } catch (error) {
                    console.error("SysAdmin anonymous login error:", error);
                    showMessage("Could not initialize admin session.", "error");
                    hideLoading();
                }
                
            } else {
                // Password is wrong
                showMessage("Invalid admin password.", "error");
                adminLoginForm.reset();
            }
        }

        async function handleLogout() {
            if (!auth) return;
            showLoading();
            try {
                await signOut(auth);
                // On success, onAuthStateChanged handles showing the login screen
            } catch (error) {
                console.error("Logout Error:", error);
                showMessage("Error signing out.", "error");
                hideLoading();
            }
        }
        
        // --- UI State Functions ---
        
        function showMainApp() {
            loginSection.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            hideLoading();
        }

        function showLoginScreen() {
            loginSection.classList.remove('hidden');
            mainAppContainer.classList.add('hidden');
            hideLoading();
        }

        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        function showMessage(message, type = "info") {
            const modalText = document.getElementById('modal-message-text');
            modalText.textContent = message;
            
            // In a real app, you might change modal color based on 'type' (e.g., 'error', 'success')
            
            messageModal.classList.remove('hidden');
        }

        function hideMessage() {
            messageModal.classList.add('hidden');
        }

        // --- Navigation ---
        function handleNav(e) {
            const targetId = e.currentTarget.id.replace('-nav-btn', '-section');

            // Update button styles
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.id === e.currentTarget.id);
            });

            // Show/hide content sections
            sections.forEach(sec => {
                sec.classList.toggle('hidden', sec.id !== targetId);
            });
        }

        // --- Firestore Data Functions ---

        function attachFirestoreListeners() {
            if (!db || !userId) {
                console.warn("Attempted to attach listeners without db or userId");
                return;
            }
            console.log(`Attaching listeners for user: ${userId}`);

            // Clients
            const clientsQuery = query(collection(db, 'artifacts', appId, 'users', userId, 'clients'));
            unsubClients = onSnapshot(clientsQuery, (snapshot) => {
                const clients = [];
                snapshot.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
                
                // Clear and render list
                clientsList.innerHTML = '';
                clients.forEach(renderClient);

                // Update select dropdowns
                updateSelectOptions(jobClientSelect, clients, "Select Client");
            }, (error) => console.error("Error listening to clients:", error));

            // Staff
            const staffQuery = query(collection(db, 'artifacts', appId, 'users', userId, 'staff'));
            unsubStaff = onSnapshot(staffQuery, (snapshot) => {
                const staff = [];
                snapshot.forEach(doc => staff.push({ id: doc.id, ...doc.data() }));
                
                // Clear and render list
                staffList.innerHTML = '';
                staff.forEach(renderStaff);
                
                // Update select dropdowns
                updateSelectOptions(jobStaffSelect, staff, "Select Staff");
                updateSelectOptions(timeStaffSelect, staff, "Select Staff");
            }, (error) => console.error("Error listening to staff:", error));

            // Jobs
            const jobsQuery = query(collection(db, 'artifacts', appId, 'users', userId, 'jobs'));
            unsubJobs = onSnapshot(jobsQuery, (snapshot) => {
                const jobs = [];
                snapshot.forEach(doc => jobs.push({ id: doc.id, ...doc.data() }));
                
                // Clear and render list
                jobsList.innerHTML = '';
                jobs.forEach(renderJob);
            }, (error) => console.error("Error listening to jobs:", error));

            // Timesheets
            const timesheetsQuery = query(collection(db, 'artifacts', appId, 'users', userId, 'timesheets'));
            unsubTimesheets = onSnapshot(timesheetsQuery, (snapshot) => {
                const entries = [];
                snapshot.forEach(doc => entries.push({ id: doc.id, ...doc.data() }));
                
                // Sort by date, most recent first
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Clear and render list
                timesheetsList.innerHTML = '';
                entries.forEach(renderTimeEntry);
            }, (error) => console.error("Error listening to timesheets:", error));
        }

        function detachFirestoreListeners() {
            console.log("Detaching all Firestore listeners.");
            unsubClients();
            unsubStaff();
            unsubJobs();
            unsubTimesheets();
        }

        // --- Render Functions ---

        function renderClient(client) {
            const el = document.createElement('div');
            el.className = 'bg-white p-4 rounded-lg shadow-md mb-3 flex justify-between items-start'; // Use items-start for alignment
            el.innerHTML = `
                <div>
                    <h4 class="font-bold text-gray-800">${client.name}</h4>
                    <p class="text-sm text-gray-600">${client.phone}</p>
                    <p class="text-sm text-gray-600">${client.address}</p>
                    <span class="text-xs font-semibold ${client.type === 'commercial' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'} px-2 py-0.5 rounded-full">${client.type}</span>
                </div>
                <button data-id="${client.id}" class="delete-client-btn text-red-500 hover:text-red-700 font-medium text-lg">
                    &times;
                </button>
            `;
            clientsList.appendChild(el);
            el.querySelector('.delete-client-btn').addEventListener('click', () => deleteClient(client.id));
        }

        function renderStaff(staff) {
            // Helper object for role colors
            const roleColors = {
                'Owner': 'bg-red-100 text-red-800',
                'Manager': 'bg-blue-100 text-blue-800',
                'Team Leader': 'bg-indigo-100 text-indigo-800',
                'Cleaner': 'bg-green-100 text-green-800',
                'SysAdmin': 'bg-gray-100 text-gray-800',
                'default': 'bg-gray-100 text-gray-500'
            };
            
            const colorClass = roleColors[staff.type] || roleColors['default'];
            const typeName = staff.type || 'No Role';

            const el = document.createElement('div');
            el.className = 'bg-white p-4 rounded-lg shadow-md mb-3'; // Removed flex
            el.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-gray-800">${staff.name}</h4>
                        <span class="text-xs font-semibold ${colorClass} px-2 py-0.5 rounded-full">${typeName}</span>
                    </div>
                    <button data-id="${staff.id}" class="delete-staff-btn text-red-500 hover:text-red-700 font-medium text-lg">
                        &times;
                    </button>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-600 space-y-1">
                    <p><strong>Phone:</strong> ${staff.phone || 'N/A'}</p>
                    <p><strong>Email:</strong> ${staff.email || 'N/A'}</p>
                    <p><strong>Address:</strong> ${staff.address || 'N/A'}</p>
                    <p><strong>Start Date:</strong> ${staff.startDate ? new Date(staff.startDate + 'T00:00:00').toLocaleDateString() : 'N/A'}</p>
                    <p><strong>Pay Rate:</strong> $${staff.payRate ? Number(staff.payRate).toFixed(2) : '0.00'}/hr</p>
                </div>
            `;
            staffList.appendChild(el);
            el.querySelector('.delete-staff-btn').addEventListener('click', () => deleteStaff(staff.id));
        }

        function renderJob(job) {
            const el = document.createElement('div');
            el.className = 'bg-white p-4 rounded-lg shadow-md mb-3';
            
            // Format date for display
            const jobDate = new Date(job.date + 'T00:00:00'); // Ensure it's treated as local date
            const displayDate = jobDate.toLocaleDateString(undefined, {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            el.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-gray-800">${job.clientName}</h4>
                        <p class="text-sm text-gray-600">Assigned to: ${job.staffName}</p>
                    </div>
                    <span class="text-sm font-semibold text-emerald-800">${displayDate}</span>
                </div>
                <div class="text-right mt-2">
                    <button data-id="${job.id}" class="delete-job-btn text-red-500 hover:text-red-700 font-medium text-lg">
                        &times;
                    </button>
                </div>
            `;
            jobsList.appendChild(el);
            el.querySelector('.delete-job-btn').addEventListener('click', () => deleteJob(job.id));
        }

        function renderTimeEntry(entry) {
            const el = document.createElement('tr');
            
            // Format date for display
            const entryDate = new Date(entry.date + 'T00:00:00'); // Ensure local date
            const displayDate = entryDate.toLocaleDateString();

            el.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.staffName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${Number(entry.hours).toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button data-id="${entry.id}" class="delete-time-btn text-red-500 hover:text-red-700">
                        Delete
                    </button>
                </td>
            `;
            timesheetsList.appendChild(el);
            el.querySelector('.delete-time-btn').addEventListener('click', () => deleteTimeEntry(entry.id));
        }

        // --- Helper Functions ---
        
        function updateSelectOptions(selectElement, items, defaultOptionText) {
            if (!selectElement) return;
            
            // Store current value
            const currentValue = selectElement.value;
            
            // Clear all except the default
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            
            // Add new options
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                // Add data attributes to store extra info
                if (item.phone) option.dataset.phone = item.phone;
                if (item.address) option.dataset.address = item.address;
                
                selectElement.appendChild(option);
            });
            
            // Try to re-select the previous value
            selectElement.value = currentValue;
        }

        // --- Firestore "Add" Functions ---

        async function handleAddClient(e) {
            e.preventDefault();
            if (!userId) return showMessage("You must be logged in.", "error");
            const name = addClientForm.clientName.value;
            const phone = addClientForm.clientPhone.value;
            const address = addClientForm.clientAddress.value;
            const type = addClientForm.clientType.value;
            if (!name || !phone || !address) return showMessage("Please fill out all fields.", "error");
            try {
                const clientRef = collection(db, 'artifacts', appId, 'users', userId, 'clients');
                await addDoc(clientRef, { name, phone, address, type });
                showMessage("Client added!", "success");
                addClientForm.reset();
            } catch (error) { console.error("Error adding client:", error); showMessage("Could not add client.", "error"); }
        }

        async function handleAddStaff(e) {
            e.preventDefault();
            if (!userId) return showMessage("You must be logged in.", "error");
            
            const name = addStaffForm.staffName.value;
            const type = addStaffForm.staffType.value;
            const phone = addStaffForm.staffPhone.value;
            const email = addStaffForm.staffEmail.value;
            const address = addStaffForm.staffAddress.value;
            const startDate = addStaffForm.staffStartDate.value;
            const payRate = parseFloat(addStaffForm.staffPayRate.value) || 0;

            if (!name || !type || !phone || !email || !startDate) {
                return showMessage("Please fill out name, role, phone, email, and start date.", "error");
            }

            try {
                const staffRef = collection(db, 'artifacts', appId, 'users', userId, 'staff');
                await addDoc(staffRef, { 
                    name, 
                    type, 
                    phone, 
                    email, 
                    address, 
                    startDate, 
                    payRate 
                });
                showMessage("Staff member added!", "success");
                addStaffForm.reset();
            } catch (error) { console.error("Error adding staff:", error); showMessage("Could not add staff member.", "error"); }
        }
        
        async function handleAddJob(e) {
            e.preventDefault();
            if (!userId) return showMessage("You must be logged in.", "error");
            const clientId = addJobForm.jobClient.value;
            const staffId = addJobForm.jobStaff.value;
            const date = addJobForm.jobDate.value;
            if (!clientId || !staffId || !date) return showMessage("Please fill out all fields.", "error");

            const clientName = addJobForm.jobClient.options[addJobForm.jobClient.selectedIndex].text;
            const staffName = addJobForm.jobStaff.options[addJobForm.jobStaff.selectedIndex].text;

            try {
                const jobRef = collection(db, 'artifacts', appId, 'users', userId, 'jobs');
                await addDoc(jobRef, { clientId, clientName, staffId, staffName, date });
                showMessage("Job added!", "success");
                addJobForm.reset();
            } catch (error) { console.error("Error adding job:", error); showMessage("Could not add job.", "error"); }
        }
        
        async function handleAddTime(e) {
            e.preventDefault();
            if (!userId) return showMessage("You must be logged in.", "error");
            const staffId = addTimeForm.timeStaff.value;
            const date = addTimeForm.timeDate.value;
            const hours = parseFloat(addTimeForm.timeHours.value);
            if (!staffId || !date || !hours || hours <= 0) return showMessage("Please fill out all fields correctly.", "error");

            const staffName = addTimeForm.timeStaff.options[addTimeForm.timeStaff.selectedIndex].text;

            try {
                const timeRef = collection(db, 'artifacts', appId, 'users', userId, 'timesheets');
                await addDoc(timeRef, { staffId, staffName, date, hours });
                showMessage("Time logged!", "success");
                addTimeForm.reset();
            } catch (error) { console.error("Error logging time:", error); showMessage("Could not log time.", "error"); }
        }

        // --- Firestore "Delete" Functions ---
        
        async function deleteClient(id) {
            if (!userId) return showMessage("You must be logged in.", "error");
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', id));
                showMessage("Client deleted.", "success");
            } catch (error) { console.error("Error deleting client:", error); showMessage("Could not delete client.", "error"); }
        }
        
        async function deleteStaff(id) {
            if (!userId) return showMessage("You must be logged in.", "error");
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'staff', id));
                showMessage("Staff deleted.", "success");
            } catch (error) { console.error("Error deleting staff:", error); showMessage("Could not delete staff.", "error"); }
        }
        
        async function deleteJob(id) {
            if (!userId) return showMessage("You must be logged in.", "error");
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'jobs', id));
                showMessage("Job deleted.", "success");
            } catch (error) { console.error("Error deleting job:", error); showMessage("Could not delete job.", "error"); }
        }
        
        async function deleteTimeEntry(id) {
            if (!userId) return showMessage("You must be logged in.", "error");
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'timesheets', id));
                showMessage("Time entry deleted.", "success");
            } catch (error) { console.error("Error deleting time entry:", error); showMessage("Could not delete time entry.", "error"); }
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get major containers
            loginSection = document.getElementById('login-section');
            mainAppContainer = document.getElementById('app-container');
            loadingSpinner = document.getElementById('loading-spinner');
            
            // Get Message Modal
            messageModal = document.getElementById('message-modal');
            document.getElementById('modal-close-btn').addEventListener('click', hideMessage);

            // Get Auth buttons
            googleLoginBtn = document.getElementById('google-login-btn');
            adminLoginForm = document.getElementById('admin-login-form');
            logoutBtn = document.getElementById('logout-btn');

            // Get forms
            addJobForm = document.getElementById('add-job-form');
            addClientForm = document.getElementById('add-client-form');
            addStaffForm = document.getElementById('add-staff-form');
            addTimeForm = document.getElementById('add-time-form');

            // Get lists
            jobsList = document.getElementById('jobs-list');
            clientsList = document.getElementById('clients-list');
            staffList = document.getElementById('staff-list');
            timesheetsList = document.getElementById('timesheets-list');

            // Get select dropdowns
            jobClientSelect = document.getElementById('job-client');
            jobStaffSelect = document.getElementById('job-staff');
            timeStaffSelect = document.getElementById('time-staff');

            // Get Nav buttons and Sections
            navButtons = document.querySelectorAll('.nav-btn');
            sections = document.querySelectorAll('main > section');

            // --- Attach Event Listeners ---
            
            // Nav
            navButtons.forEach(btn => btn.addEventListener('click', handleNav));
            
            // Auth
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
            adminLoginForm.addEventListener('submit', handleAdminLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Forms
            addJobForm.addEventListener('submit', handleAddJob);
            addClientForm.addEventListener('submit', handleAddClient);
            addStaffForm.addEventListener('submit', handleAddStaff);
            addTimeForm.addEventListener('submit', handleAddTime);

            // Start the app
            showLoading(); // Show spinner on initial load
            initializeFirebase();
        });

    </script>
</body>
</html>

